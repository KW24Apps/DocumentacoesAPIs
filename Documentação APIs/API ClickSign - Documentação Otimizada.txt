### CLICKSIGN API - DOCUMENTAÇÃO TÉCNICA COMPLETA

**Versões da API:**
- V1: Documentos individuais (PRODUÇÃO)
- V2: Envelopes (PRODUÇÃO - teórico)  
- V3: Sandbox apenas (NÃO usar em produção)

**Base URLs:**
- Produção: `https://app.clicksign.com`
- Sandbox: `https://sandbox.clicksign.com`

**Autenticação:** `?access_token={{access_token}}`

---

## CÓDIGOS DE ERRO HTTP

**4xx - Erros do Cliente:**
- 400: BAD REQUEST - Erro na requisição
- 401: UNAUTHORIZED - Access Token inválido
- 403: FORBIDDEN - Token sem permissão
- 404: NOT FOUND - Recurso não encontrado
- 422: UNPROCESSABLE ENTITY - Dados inválidos

**5xx - Erros do Servidor:**
- 500: INTERNAL SERVER ERROR

**Formato de Erro JSON:**
```json
{
  "errors": [{
    "code": "bad_request",
    "status": 400,
    "source": {"pointer": "/data/attributes/filename"},
    "detail": "filename deve ser informado(a)"
  }]
}
```

---

## LIMITES E SEGURANÇA

**Rate Limiting:**
- Produção: 50 req/conta/10s
- Sandbox: 20 req/conta/10s
- Headers: `X-Rate-Limit`, `X-Rate-Limit-Remaining`, `X-Rate-Limit-Reset`

**Segurança TLS:**
- Protocolo: TLS 1.2 obrigatório
- 12 cifras suportadas (ECDHE-*, AES*)

**IPs dos Webhooks:**
- Produção: `34.204.113.69`
- Sandbox: `54.210.30.253`

---

## DOCUMENTOS (V1 API)

### Criar Documento
`POST /api/v1/documents`

**Campos Obrigatórios:**
- `path`: Caminho com nome do arquivo (inicia com "/")
- `content_base64`: `data:<mimetype>;base64,<data>`

**Campos Opcionais:**
- `deadline_at`: Data limite (máx 90 dias, padrão 30 dias)
- `auto_close`: bool (padrão: true)
- `locale`: "pt-BR"|"en-US" (padrão: "pt-BR")
- `sequence_enabled`: bool (padrão: false)
- `remind_interval`: null|1|2|3|7|14 (padrão: null)
- `block_after_refusal`: bool (padrão: true)

**MIME Types Suportados:**
- text/plain, image/png, image/jpeg, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document

### Visualizar Documento
`GET /api/v1/documents/:key`

**Response Principais Campos:**
- `key`: UUID único
- `status`: "running"|"closed"|"canceled"
- `downloads.original_file_url`: Download original (válido 5min)
- `downloads.signed_file_url`: Download assinado (válido 5min)
- `downloads.ziped_file_url`: ZIP completo (válido 5min)

### Listar Documentos
`GET /api/v1/documents?page=number`
- Paginação: 30 docs por página

### Configurar Documento
`PATCH /api/v1/documents/:key`
- Permite alterar: deadline_at, auto_close, locale, sequence_enabled, remind_interval, block_after_refusal

### Finalizar Documento
`PATCH /api/v1/documents/:key/finish`

### Cancelar Documento
`PATCH /api/v1/documents/:key/cancel`

### Excluir Documento
`DELETE /api/v1/documents/:key`
- Apenas documentos finalizados ou cancelados

---

## SIGNATÁRIOS (V1/V2 API)

### Criar Signatário
`POST /api/v1/signers`

**Campo Obrigatório:**
- `auths`: ["email"]|["sms"]|["whatsapp"]|["pix"]|["api"]|["icp_brasil"]

**Campos Opcionais Principais:**
- `email`: Obrigatório se auths=email/api ou communicate_by=email
- `phone_number`: Obrigatório se auths=sms/whatsapp (10-11 dígitos)
- `name`: Nome completo (mín 2 palavras, sem números)
- `documentation`: CPF válido
- `birthday`: Formato AAAA-MM-DD
- `has_documentation`: bool (padrão: true)
- `communicate_by`: "email"|"whatsapp" (padrão: "email")

**Autenticações Avançadas:**
- `selfie_enabled`: bool (padrão: false)
- `handwritten_enabled`: bool (padrão: false)
- `official_document_enabled`: bool (padrão: false)
- `liveness_enabled`: bool (padrão: false)
- `facial_biometrics_enabled`: bool (padrão: false)
- `location_required_enabled`: bool (padrão: false)

### Visualizar Signatário
`GET /api/v1/signers/:key`

### Listar Signatários
`GET /api/v2/signers?page=number`
- Paginação: 30 signatários por página

### Excluir Signatário
`DELETE /api/v2/signers/:signer_key`

### Adicionar Signatário a Documento
`POST /api/v1/lists`

**Campos Obrigatórios:**
- `document_key`: UUID do documento
- `signer_key`: UUID do signatário
- `sign_as`: Papel do signatário

**Papéis Principais:**
- `sign`: Apenas assinar
- `contractor`: Contratante
- `contractee`: Contratada
- `witness`: Testemunha
- `guarantor`: Avalista
- `party`: Parte

**Campos Opcionais:**
- `group`: Número do grupo (para sequence_enabled)
- `message`: Mensagem personalizada (usar \n para quebras)
- `refusable`: bool (padrão: false)

### Remover Signatário de Documento
`DELETE /api/v1/lists/:list_key`
- list_key obtido em: `$.document.signers[0].list_key`

---

## NOTIFICAÇÕES

### Notificação por Email
`POST /api/v1/notifications`

**Campos:**
- `request_signature_key`: Chave da assinatura
- `message`: Texto do email (usar \n para quebras)
- `url`: URL customizada (opcional)

### Notificação por WhatsApp
`POST /api/v1/notify_by_whatsapp`

**Campos:**
- `request_signature_key`: Chave da assinatura
- Requisito: auths=["whatsapp"]

### Assinatura via API
`POST /api/v1/sign`

**Campos Obrigatórios:**
- `request_signature_key`: Chave da assinatura
- `secret_hmac_sha256`: HMAC SHA256(request_signature_key + secret)

**Pré-requisitos:**
1. Signatário com auths=["api"]
2. Termo de Autorização assinado
3. Secret fornecido pela Clicksign

### Lotes de Assinatura
`POST /api/v1/batches`

**Campos:**
- `document_keys`: Array de UUIDs (máx 500 documentos)
- `signer_key`: UUID do signatário
- `summary`: bool (layout colapsado ou sequencial)

---

## ENVELOPES (V2 API - PRODUÇÃO TEÓRICA)

### Campos dos Envelopes

**Obrigatórios na Criação:**
- `name`: Nome do envelope

**Opcionais:**
- `locale`: "pt-BR"|"en-US" (padrão: "pt-BR")
- `auto_close`: bool (padrão: true)
- `remind_interval`: null|1|2|3|7|14 (padrão: 3)
- `block_after_refusal`: bool (padrão: false)
- `deadline_at`: datetime (padrão: +30 dias, máx: 90 dias)
- `default_subject`: string (máx 100 chars)
- `default_message`: string

**Status Workflow:**
- `draft` → `running` → `closed`/`canceled`

### Criar Envelope
`POST /api/v2/envelopes`

### Visualizar Envelope
`GET /api/v2/envelopes/:key`

### Atualizar Envelope
`PATCH /api/v2/envelopes/:key`
- `name` não editável após criação
- `default_subject` apenas em status=draft

### Adicionar Documento ao Envelope
`POST /api/v2/envelopes/:envelope_key/documents`
```json
{"document_key": "uuid-do-documento"}
```

### Remover Documento do Envelope
`DELETE /api/v2/envelopes/:envelope_key/documents/:document_key`

### Finalizar Envelope
`PATCH /api/v2/envelopes/:key/finish`

### Cancelar Envelope
`PATCH /api/v2/envelopes/:key/cancel`

### Excluir Envelope
`DELETE /api/v2/envelopes/:key`

---

## ACEITE VIA WHATSAPP (V2 API)

### Criar Aceite
`POST /api/v2/acceptance_term/whatsapps`

**Campos Obrigatórios:**
- `name`: Título do aceite
- `sender_name`: "user_name"|"account_name"|"user_and_account_name"
- `content`: Conteúdo do aceite
- `signer_phone`: Telefone do destinatário
- `signer_name`: Nome do destinatário

**Regra:** Soma de chars(name + content) ≤ 1500

**Campos Opcionais:**
- `sender_phone`: Telefone do remetente

### Visualizar Aceite
`GET /api/v2/acceptance_term/whatsapps/:key`

### Listar Aceites
`GET /api/v2/acceptance_term/whatsapps?page=number`

### Cancelar Aceite
`PATCH /api/v2/acceptance_term/whatsapps/:key/cancel`

**Status do Aceite:**
- `enqueued`: Na fila
- `sent`: Enviado
- `completed`: Aceito
- `canceled`: Cancelado
- `refused`: Recusado
- `expired`: Expirado
- `error`: Erro

---

## WEBHOOKS

### Cadastrar Webhook
`POST /api/v2/webhooks`

**Campos Obrigatórios:**
- `endpoint`: URL para receber eventos
- `status`: "active"
- `events`: Array de eventos

### Consultar Webhooks
`GET /api/v2/webhooks`

### Eventos de Documentos (13 tipos)
- `upload`: Upload realizado
- `add_signer`: Signatário adicionado
- `remove_signer`: Signatário removido
- `sign`: Documento assinado
- `refusal`: Documento recusado
- `close`: Finalizado manualmente
- `auto_close`: Finalizado automaticamente
- `cancel`: Cancelado manualmente
- `deadline`: Prazo atingido
- `document_closed`: Pronto para download
- `update_deadline`: Prazo alterado
- `update_auto_close`: Auto-close alterado
- `attempts_by_whatsapp_exceeded`: Tentativas WhatsApp esgotadas

### Eventos de Aceite WhatsApp (7 tipos)
- `acceptance_term_sent`: Aceite enviado
- `acceptance_term_completed`: Aceite finalizado
- `acceptance_term_canceled`: Aceite cancelado
- `acceptance_term_refused`: Aceite recusado
- `acceptance_term_expired`: Aceite expirado
- `acceptance_term_enqueued`: Aceite na fila
- `acceptance_term_error`: Erro no aceite

### Segurança dos Webhooks

**Timeout:** 5 segundos
**Tentativas:** 10 tentativas em 24h
**HMAC:** SHA256(body + secret)
**Header:** `Content-Hmac: sha256=hash`

**Anatomia da Requisição:**
```http
POST /webhook HTTP/1.1
Content-Type: application/json
Event: nome_do_evento
Content-Hmac: sha256=hash_calculado
```

**Estrutura do Body:**
```json
{
  "event": {
    "name": "nome_evento",
    "data": {...},
    "occurred_at": "ISO_DATE"
  },
  "document": {...},
  "signers": [...],
  "events": [...]
}
```

### Validação HMAC
```
hash_esperado = SHA256(json_body + webhook_secret)
if (hash_recebido === hash_esperado) { /* válido */ }
```

---

## CAMPOS PRINCIPAIS DOS OBJETOS

### Documento
```json
{
  "key": "uuid",
  "status": "running|closed|canceled",
  "filename": "nome.pdf",
  "path": "/caminho/completo.pdf",
  "uploaded_at": "ISO_DATE",
  "updated_at": "ISO_DATE", 
  "finished_at": "ISO_DATE|null",
  "deadline_at": "ISO_DATE",
  "auto_close": true,
  "locale": "pt-BR",
  "sequence_enabled": false,
  "remind_interval": 3,
  "block_after_refusal": true,
  "downloads": {
    "original_file_url": "S3_URL",
    "signed_file_url": "S3_URL", 
    "ziped_file_url": "S3_URL"
  },
  "signers": [...]
}
```

### Signatário
```json
{
  "key": "uuid",
  "list_key": "uuid",
  "request_signature_key": "uuid",
  "email": "email@domain.com",
  "name": "Nome Completo",
  "phone_number": "11999999999",
  "documentation": "000.000.000-00",
  "birthday": "1990-01-01",
  "auths": ["email"],
  "sign_as": "contractor",
  "delivery": "email",
  "refusable": false,
  "url": "https://app.clicksign.com/sign/uuid",
  "created_at": "ISO_DATE"
}
```

### Envelope
```json
{
  "key": "uuid",
  "name": "Nome do Envelope",
  "status": "draft|running|closed|canceled",
  "locale": "pt-BR",
  "auto_close": true,
  "remind_interval": 3,
  "block_after_refusal": false,
  "deadline_at": "ISO_DATE",
  "default_subject": "Assunto Email",
  "default_message": "Mensagem Padrão",
  "created_at": "ISO_DATE",
  "updated_at": "ISO_DATE",
  "documents": [...],
  "signers": [...]
}
```

---

## FLUXOS OPERACIONAIS TÍPICOS

### Fluxo Documento Individual
1. `POST /api/v1/documents` - Criar documento
2. `POST /api/v1/signers` - Criar signatário  
3. `POST /api/v1/lists` - Vincular signatário ao documento
4. `POST /api/v1/notifications` - Notificar por email
5. `POST /api/v1/notify_by_whatsapp` - Notificar por WhatsApp
6. Signatário assina via interface web
7. Webhook `sign` disparado
8. Webhook `document_closed` quando finalizado

### Fluxo Envelope (Múltiplos Documentos)
1. `POST /api/v2/envelopes` - Criar envelope (status=draft)
2. `POST /api/v1/documents` - Criar documento 1
3. `POST /api/v1/documents` - Criar documento 2  
4. `POST /api/v2/envelopes/:id/documents` - Adicionar doc 1
5. `POST /api/v2/envelopes/:id/documents` - Adicionar doc 2
6. `POST /api/v1/signers` - Criar signatário
7. `POST /api/v1/lists` - Vincular aos documentos do envelope
8. `PATCH /api/v2/envelopes/:id` - Ativar (status=running)
9. Signatário assina todos documentos do envelope
10. Webhooks disparados para cada documento

### Fluxo Aceite WhatsApp
1. `POST /api/v2/acceptance_term/whatsapps` - Criar aceite
2. WhatsApp automático enviado
3. Destinatário aceita via WhatsApp
4. Webhook `acceptance_term_completed` disparado
5. `GET /api/v2/acceptance_term/whatsapps/:key` - Verificar status

---

## VALIDAÇÕES E REGRAS IMPORTANTES

**Prazos:**
- Deadline máximo: 90 dias do upload
- Deadline mínimo: Data/hora atual
- Documento cancelado automaticamente se sem assinaturas no deadline

**Lembretes:**
- Máximo 3 lembretes automáticos
- WhatsApp: custo adicional por lembrete
- Intervalos válidos: 1, 2, 3, 7, 14 dias

**Autenticações:**
- ICP Brasil: incompatível com selfie/liveness/official_document
- PIX: requer CPF válido
- Facial biometrics: incompatível com outras autenticações
- API: requer Termo de Autorização assinado

**Limites de Caracteres:**
- Aceite WhatsApp: name + content ≤ 1500 chars
- Envelope subject: ≤ 100 chars
- CPF: deve ser válido e formatado
- Telefone: 10-11 dígitos

**URLs de Download:**
- Validade: 5 minutos
- Não contam no rate limit
- Padrão S3: `clicksign-content-{env}.s3.amazonaws.com`

**Status de Documentos:**
- `running`: Em processo de assinatura
- `closed`: Finalizado (com assinaturas)
- `canceled`: Cancelado (sem assinaturas ou manual)

**Webhooks:**
- Timeout: 5 segundos
- Status 2xx: sucesso
- Outros status: reenvio automático
- 10 tentativas em 24 horas máximo
